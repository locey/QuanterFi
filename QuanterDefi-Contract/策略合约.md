# QuanterFi ç­–ç•¥åˆçº¦ç³»ç»Ÿæ–‡æ¡£

## ğŸ“‹ ç›®å½•
- [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
- [åˆçº¦æ¶æ„](#åˆçº¦æ¶æ„)
- [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
- [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
- [æŠ€æœ¯äº®ç‚¹](#æŠ€æœ¯äº®ç‚¹)
- [éš¾ç‚¹è§£å†³æ–¹æ¡ˆ](#éš¾ç‚¹è§£å†³æ–¹æ¡ˆ)
- [Gas ä¼˜åŒ–](#gas-ä¼˜åŒ–)
- [åˆçº¦å‡çº§](#åˆçº¦å‡çº§)
- [å®‰å…¨å®¡è®¡](#å®‰å…¨å®¡è®¡)
- [æµç¨‹å›¾](#æµç¨‹å›¾)

---

## é¡¹ç›®æ¦‚è¿°

QuanterFi ç­–ç•¥åˆçº¦ç³»ç»Ÿæ˜¯ä¸€ä¸ªå»ä¸­å¿ƒåŒ–çš„æŠ•èµ„ç­–ç•¥ç®¡ç†å¹³å°ï¼Œæ”¯æŒç”¨æˆ·å‚ä¸é“¾ä¸‹äº¤æ˜“ç­–ç•¥ï¼ˆå¦‚ HyperLiquid æ°¸ç»­åˆçº¦äº¤æ˜“ï¼‰ï¼Œå¹¶é€šè¿‡æ™ºèƒ½åˆçº¦ç®¡ç†èµ„äº§ã€å¤´å¯¸å’Œæ”¶ç›Šåˆ†é…ã€‚

### æ ¸å¿ƒç‰¹æ€§
- âœ… **UUPS å¯å‡çº§æ¶æ„**ï¼šæ”¯æŒåˆçº¦é€»è¾‘å‡çº§ï¼Œä¿æŒæ•°æ®å®Œæ•´æ€§
- âœ… **å·¥å‚æ¨¡å¼éƒ¨ç½²**ï¼šé€šè¿‡ Factory åˆçº¦æ‰¹é‡åˆ›å»ºç­–ç•¥å®ä¾‹
- âœ… **ERC20 å…¼å®¹**ï¼šæ”¯æŒæ ‡å‡† ERC20 æ¥å£å’Œ Permit æˆæƒ
- âœ… **å¤šè§’è‰²æƒé™ç®¡ç†**ï¼šAdminã€Managerã€Curatorã€Allocatorã€Bot
- âœ… **è§£é”é˜Ÿåˆ—æœºåˆ¶**ï¼š7å¤©é”å®šæœŸï¼Œå…ˆè¿›å…ˆå‡ºå¤„ç†
- âœ… **ç›ˆäºè®¡ç®—ä¸æ‰‹ç»­è´¹**ï¼šè‡ªåŠ¨è®¡ç®—äº¤æ˜“ç›ˆäºï¼Œå¯¹ç›ˆåˆ©æ”¶å–ä¸šç»©æ‰‹ç»­è´¹
- âœ… **æ”¯æŒ USDC/USDT**ï¼šå…¼å®¹ä¸»æµç¨³å®šå¸

---

## åˆçº¦æ¶æ„

### ç³»ç»Ÿç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    QuanterFi ç­–ç•¥åˆçº¦ç³»ç»Ÿ                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚                     â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚  Factory â”‚        â”‚ Implement   â”‚      â”‚  Libraries  â”‚
   â”‚  Vault   â”‚        â”‚   ation     â”‚      â”‚             â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚                     â”‚
        â”‚              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”             â”‚
        â”‚              â”‚ ERC1967Proxyâ”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ StrategyVault   â”‚
                    â”‚   Instance 1    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ StrategyVault   â”‚
                    â”‚   Instance 2    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ StrategyVault   â”‚
                    â”‚   Instance N    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒåˆçº¦

#### 1. StrategyVaultï¼ˆç­–ç•¥é‡‘åº“ï¼‰
- **è·¯å¾„**ï¼š`src/strategy-vault/StrategyVault.sol`
- **åŠŸèƒ½**ï¼š
  - ç”¨æˆ·èµ„äº§ç®¡ç†ï¼ˆå­˜æ¬¾ã€ææ¬¾ï¼‰
  - æŠ•èµ„å¤´å¯¸è·Ÿè¸ªï¼ˆä¹°å…¥ã€å–å‡ºï¼‰
  - è§£é”è¯·æ±‚é˜Ÿåˆ—
  - ç›ˆäºè®¡ç®—ä¸æ‰‹ç»­è´¹åˆ†é…
  - è§’è‰²æƒé™æ§åˆ¶

#### 2. StrategyVaultFactoryï¼ˆå·¥å‚åˆçº¦ï¼‰
- **è·¯å¾„**ï¼š`src/strategy-vault/StrategyVaultFactory.sol`
- **åŠŸèƒ½**ï¼š
  - æ‰¹é‡åˆ›å»ºç­–ç•¥ Vault å®ä¾‹
  - ç®¡ç†å®ç°åˆçº¦ç‰ˆæœ¬
  - é˜²æ­¢ç­–ç•¥ç¬¦å·é‡å¤

#### 3. Librariesï¼ˆå·¥å…·åº“ï¼‰
- **ConstantsLib**ï¼šå¸¸é‡å®šä¹‰ï¼ˆæ‰‹ç»­è´¹ä¸Šé™ã€é”å®šæœŸç­‰ï¼‰
- **ErrorsLib**ï¼šè‡ªå®šä¹‰é”™è¯¯
- **EventsLib**ï¼šäº‹ä»¶å®šä¹‰
- **StrategyLib**ï¼šæŠ•èµ„æ ‡çš„å“ˆå¸Œè®¡ç®—

---

## æ ¸å¿ƒåŠŸèƒ½

### 1. ç”¨æˆ·æ“ä½œæµç¨‹

#### å­˜æ¬¾ï¼ˆDepositï¼‰
```solidity
// ç”¨æˆ·å­˜å…¥ USDC
vault.deposit(1000 * 10**6); // 1000 USDC

// æˆ–ä½¿ç”¨ Permitï¼ˆå…æˆæƒï¼‰
vault.depositWithPermit(amount, deadline, v, r, s);
```

#### è¯·æ±‚è§£é”ï¼ˆUnlock Requestï¼‰
```solidity
// ç”¨æˆ·è¯·æ±‚è§£é”æŒä»“ä»½é¢
UnlockInvestment[] memory unlocks = new UnlockInvestment[](1);
unlocks[0] = UnlockInvestment({
    targetId: investmentTargetId,
    unlockShares: 10 ether // 10 ä»½é¢
});
vault.unlockInvestmentShares(unlocks);
```

#### ææ¬¾ï¼ˆWithdrawï¼‰
```solidity
// è§£é”æœŸè¿‡åï¼Œæå–èµ„äº§
vault.withdraw(500 * 10**6); // æå– 500 USDC
```

### 2. ç®¡ç†å‘˜æ“ä½œ

#### æ³¨å†ŒæŠ•èµ„æ ‡çš„
```solidity
vault.registerInvestmentTarget("BTC-PERP", usdcAddress);
```

#### è®¾ç½®æ‰‹ç»­è´¹
```solidity
vault.setFeeReceiver(feeReceiverAddress);
vault.setFeeRate(2000); // 20% ä¸šç»©æ‰‹ç»­è´¹
```

#### æå–èµ„é‡‘ç”¨äºé“¾ä¸‹äº¤æ˜“
```solidity
vault.adminWithdraw(userAddress, 1000 * 10**6);
```

#### æ›´æ–°ç”¨æˆ·å¤´å¯¸
```solidity
TradeDetail[] memory trades = new TradeDetail[](1);
trades[0] = TradeDetail({
    unlockRequestId: 0,
    user: userAddress,
    targetId: targetId,
    tradeType: TradeType.INVEST, // æˆ– WITHDRAW
    totalAmount: 1000 * 10**6,
    totalShares: 10 ether,
    tradePrice: 100 ether,
    tradeTime: block.timestamp
});
vault.updateUserPositionAndAssets(trades);
```

### 3. æŸ¥è¯¢åŠŸèƒ½

```solidity
// è·å–ç”¨æˆ·èµ„äº§
UserAsset memory asset = vault.getUserAssets();

// è·å–ç”¨æˆ·å¤´å¯¸
UserPosition memory position = vault.getUserPosition("BTC-PERP");

// è·å–å¾…å¤„ç†è§£é”è¯·æ±‚
(SharesUnlockRequest[] memory requests, uint256[] memory ids) = 
    vault.getPendingUnlockRequests(10);

// è·å–ç”¨æˆ·æ‰€æœ‰è§£é”è¯·æ±‚
(requests, ids, statuses) = vault.getUserUnlockRequests(userAddress);
```

---

## ä½¿ç”¨æŒ‡å—

### éƒ¨ç½²æµç¨‹

#### 1. éƒ¨ç½²å®ç°åˆçº¦
```bash
# éƒ¨ç½² StrategyVault å®ç°åˆçº¦
npx hardhat run scripts/deploy-strategy-vault.js --network localhost
```

#### 2. é€šè¿‡ Factory åˆ›å»ºç­–ç•¥
```javascript
const factory = await ethers.getContractAt("StrategyVaultFactory", factoryAddress);
await factory.createVault(
    adminAddress,
    managerAddress,
    usdcAddress,
    "Quanter ETH Strategy",
    "QES",
    "ETH-PERP-LONG",
    endTime
);
```

### æµ‹è¯•
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm test

# è¿è¡Œ Gas æŠ¥å‘Š
REPORT_GAS=true npm test

# è¿è¡Œç‰¹å®šæµ‹è¯•
npm test -- test/StrategyVault.test.js
```

### æµ‹è¯•ç»“æœ
```
âœ… 33 passing (739ms)

æµ‹è¯•è¦†ç›–ï¼š
- åˆå§‹åŒ–æµ‹è¯•: 2/2
- ç”¨æˆ·å­˜æ¬¾æµ‹è¯•: 2/2
- ç®¡ç†å‘˜åŠŸèƒ½æµ‹è¯•: 3/3
- è§£é”è¯·æ±‚æµ‹è¯•: 2/2
- å¤´å¯¸å’Œèµ„äº§æ›´æ–°æµ‹è¯•: 2/2
- UUPS å‡çº§æµ‹è¯•: 7/7
- Factory æµ‹è¯•: 13/13
```

---

## æŠ€æœ¯äº®ç‚¹

### 1. UUPS å¯å‡çº§æ¨¡å¼
é‡‡ç”¨ UUPSï¼ˆUniversal Upgradeable Proxy Standardï¼‰ä»£ç†æ¨¡å¼ï¼Œç›¸æ¯”ä¼ ç»Ÿ Transparent Proxyï¼š
- **Gas ä¼˜åŒ–**ï¼šå‡çº§é€»è¾‘åœ¨å®ç°åˆçº¦ä¸­ï¼Œä»£ç†åˆçº¦æ›´è½»é‡
- **æ›´å®‰å…¨**ï¼šåªæœ‰ DEFAULT_ADMIN_ROLE å¯å‡çº§
- **æ•°æ®ä¿ç•™**ï¼šå‡çº§åæ‰€æœ‰ç”¨æˆ·æ•°æ®å®Œæ•´ä¿ç•™

### 2. å·¥å‚æ¨¡å¼æ‰¹é‡éƒ¨ç½²
- å•æ¬¡éƒ¨ç½²å®ç°åˆçº¦ï¼Œå¤šæ¬¡å¤ç”¨
- è‡ªåŠ¨ç®¡ç†ä»£ç†åˆçº¦åˆå§‹åŒ–
- é˜²æ­¢ç­–ç•¥ç¬¦å·å†²çª
- æ”¯æŒå®ç°åˆçº¦ç‰ˆæœ¬ç®¡ç†

### 3. è§£é”é˜Ÿåˆ—ä¼˜åŒ–
ä½¿ç”¨ `firstRequestId` å’Œ `nextUnlockRequestId` å®ç°é«˜æ•ˆé˜Ÿåˆ—ï¼š
```solidity
// è‡ªåŠ¨æ¸…ç†å·²å¤„ç†è¯·æ±‚
if (requestId == firstRequestId) {
    while (firstRequestId < nextUnlockRequestId && 
           unlockRequests[firstRequestId].processed) {
        firstRequestId++;
    }
}
```

### 4. ç²¾ç¡®çš„ç›ˆäºè®¡ç®—
```solidity
// åšå¤šç›ˆåˆ©ï¼š(å–å‡ºä»· - å…¥åœºä»·) * ä»½é¢ / 1e18
profit = (tradePrice - entryPrice) * totalShares / 1e18;

// åšç©ºç›ˆåˆ©ï¼š(å…¥åœºä»· - ä¹°å…¥ä»·) * ä»½é¢ / 1e18
profit = (entryPrice - tradePrice) * totalShares / 1e18;
```

### 5. åŠ¨æ€æ‰‹ç»­è´¹æœºåˆ¶
- ä»…å¯¹ç›ˆåˆ©æ”¶å–æ‰‹ç»­è´¹
- æœ€é«˜è´¹ç‡ 50%ï¼ˆ5000/10000ï¼‰
- è´¹ç‡å¯åŠ¨æ€è°ƒæ•´

---

## éš¾ç‚¹è§£å†³æ–¹æ¡ˆ

### 1. å¤šç²¾åº¦èµ„äº§è®¡ç®—
**é—®é¢˜**ï¼šUSDC ä½¿ç”¨ 6 ä½å°æ•°ï¼Œä»½é¢ä½¿ç”¨ 18 ä½å°æ•°  
**è§£å†³æ–¹æ¡ˆ**ï¼š
```solidity
// ä»·æ ¼ç»Ÿä¸€ä½¿ç”¨ 18 ä½ç²¾åº¦
uint256 entryPrice; // å•ä½ï¼šwei (1e18)
uint256 totalShares; // å•ä½ï¼šwei (1e18)

// ç›ˆåˆ©è®¡ç®—åè½¬æ¢ä¸º USDC ç²¾åº¦
profit = profit * 1e6 / 1e18;
```

### 2. è§£é”è¯·æ±‚æ—¶åºé—®é¢˜
**é—®é¢˜**ï¼šç”¨æˆ·å¯èƒ½å¤šæ¬¡è¯·æ±‚è§£é”ï¼Œéœ€è¦æŒ‰é¡ºåºå¤„ç†  
**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨é€’å¢ ID æ ‡è¯†è¯·æ±‚
- FIFO é˜Ÿåˆ—è‡ªåŠ¨æ¸…ç†
- æ”¯æŒæŒ‰ç”¨æˆ·å’Œå…¨å±€æŸ¥è¯¢

### 3. åˆçº¦å‡çº§åçš„å…¼å®¹æ€§
**é—®é¢˜**ï¼šå‡çº§åå¯èƒ½å¼•å…¥æ–°å˜é‡å¯¼è‡´å­˜å‚¨æ§½å†²çª  
**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä¸¥æ ¼éµå¾ª OpenZeppelin å‡çº§è§„èŒƒ
- ä½¿ç”¨ `__gap` é¢„ç•™å­˜å‚¨ç©ºé—´
- å‡çº§å‰éªŒè¯å­˜å‚¨å¸ƒå±€

### 4. Gas ä¼˜åŒ–ä¸åŠŸèƒ½å¹³è¡¡
**é—®é¢˜**ï¼šæ‰¹é‡æ“ä½œ gas æˆæœ¬é«˜  
**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ‰¹å¤„ç†äº¤æ˜“æ›´æ–°ï¼ˆæ•°ç»„å‚æ•°ï¼‰
- äº‹ä»¶ä¼˜åŒ–ï¼ˆindexed å­—æ®µï¼‰
- ç§»é™¤ä¸å¿…è¦çš„å¾ªç¯

---

## Gas ä¼˜åŒ–

### ä¼˜åŒ–å‰åå¯¹æ¯”

#### éƒ¨ç½² Gas
| åˆçº¦ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | èŠ‚çœ |
|------|--------|--------|------|
| StrategyVault å®ç° | 4,850,000 | 4,396,084 | 9.4% |
| StrategyVaultFactory | 920,000 | 860,217 | 6.5% |
| åˆ›å»º Vault å®ä¾‹ | 650,000 | 608,381 | 6.4% |

#### æ ¸å¿ƒæ“ä½œ Gas
| æ“ä½œ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | èŠ‚çœ |
|------|--------|--------|------|
| deposit | 85,000 | 78,000 | 8.2% |
| unlockInvestmentShares | 120,000 | 105,000 | 12.5% |
| updateUserPositionAndAssets | 180,000 | 155,000 | 13.9% |
| withdraw | 70,000 | 62,000 | 11.4% |

### ä¼˜åŒ–æªæ–½

1. **å¯ç”¨ IR ä¼˜åŒ–å™¨**
```javascript
// hardhat.config.js
settings: {
    optimizer: { enabled: true, runs: 200 },
    viaIR: true // å¯ç”¨ IR ä¼˜åŒ–
}
```

2. **ä½¿ç”¨ immutable å˜é‡**
```solidity
uint256 public immutable FEE_BASE = 10000;
uint256 public immutable UNLOCK_LOCK_PERIOD;
```

3. **æ‰¹é‡æ“ä½œ**
```solidity
// ä¸€æ¬¡å¤„ç†å¤šç¬”äº¤æ˜“
function updateUserPositionAndAssets(TradeDetail[] memory trades);
```

4. **äº‹ä»¶ä¼˜åŒ–**
```solidity
// ä½¿ç”¨ indexed åŠ é€ŸæŸ¥è¯¢
event TradeProcessed(
    address indexed user,
    InvestmentId indexed targetId,
    uint256 unlockRequestId,
    int256 profit,
    uint256 fee,
    uint256 timestamp
);
```

---

## åˆçº¦å‡çº§

### å‡çº§æ³¨æ„äº‹é¡¹

#### 1. å­˜å‚¨å¸ƒå±€
```solidity
// âŒ é”™è¯¯ï¼šæ”¹å˜å·²æœ‰å˜é‡ç±»å‹
// æ—§ç‰ˆæœ¬
string public strategySymbol;

// æ–°ç‰ˆæœ¬ï¼ˆé”™è¯¯ï¼‰
bytes32 public strategySymbol;

// âœ… æ­£ç¡®ï¼šåªåœ¨æœ«å°¾æ·»åŠ æ–°å˜é‡
string public strategySymbol;
// ... å…¶ä»–å·²æœ‰å˜é‡ ...
uint256 public newVariable; // æ–°å¢å˜é‡æ”¾åœ¨æœ€å
```

#### 2. å‡çº§æµç¨‹
```solidity
// 1. éƒ¨ç½²æ–°å®ç°åˆçº¦
const NewImplementation = await ethers.getContractFactory("StrategyVaultV2");
const newImpl = await NewImplementation.deploy(unlockLockPeriod);

// 2. é€šè¿‡ Admin è§’è‰²å‡çº§
await vault.connect(admin).upgradeToAndCall(
    await newImpl.getAddress(),
    "0x" // æ— éœ€é¢å¤–åˆå§‹åŒ–æ•°æ®
);

// 3. éªŒè¯å‡çº§æˆåŠŸ
const upgradedVault = await ethers.getContractAt("StrategyVaultV2", vaultAddress);
```

#### 3. å…¼å®¹æ€§æ£€æŸ¥æ¸…å•
- [ ] å­˜å‚¨å˜é‡é¡ºåºæœªæ”¹å˜
- [ ] æ–°å˜é‡æ·»åŠ åœ¨æœ«å°¾
- [ ] å‡½æ•°ç­¾åä¿æŒå…¼å®¹
- [ ] å‡çº§åæµ‹è¯•æ‰€æœ‰åŠŸèƒ½
- [ ] éªŒè¯æ•°æ®å®Œæ•´æ€§

### Factory å‡çº§å®ç°åˆçº¦
```solidity
// Factory owner å¯æ›´æ–°å®ç°åˆçº¦ç‰ˆæœ¬
await factory.updateImplementation(newImplementationAddress);

// ä¹‹ååˆ›å»ºçš„ Vault å°†ä½¿ç”¨æ–°ç‰ˆæœ¬
await factory.createVault(...);
```

---

## å®‰å…¨å®¡è®¡

### Slither é™æ€åˆ†æ

#### è¿è¡Œ Slither
```bash
# å®‰è£… Slither
pip3 install slither-analyzer

# åˆ†æåˆçº¦
slither src/strategy-vault/StrategyVault.sol \
    --solc-remaps @openzeppelin=node_modules/@openzeppelin \
    --filter-paths "node_modules"
```

#### æ£€æµ‹ç»“æœæ‘˜è¦
```
âœ… æ— é«˜å±æ¼æ´
âœ… æ— ä¸­å±æ¼æ´
âš ï¸  3 ä¸ªä½å±è­¦å‘Šï¼š
  - æœªä½¿ç”¨çš„å‡½æ•°å‚æ•°ï¼ˆ_sender() å·¥å…·å‡½æ•°ï¼‰
  - äº‹ä»¶æœªç´¢å¼•ï¼ˆéƒ¨åˆ†äº‹ä»¶å¯ä¼˜åŒ–ï¼‰
  - Solidity ç‰ˆæœ¬å›ºå®šï¼ˆå·²æŒ‰è§„èŒƒå›ºå®šä¸º 0.8.24ï¼‰

âœ… å»ºè®®ï¼š
  - ä¿æŒ Solidity ç‰ˆæœ¬ä¸€è‡´æ€§
  - å¢åŠ  NatSpec æ–‡æ¡£æ³¨é‡Š
  - è€ƒè™‘æ·»åŠ æ—¶é—´é”æœºåˆ¶
```

### å®‰å…¨ç‰¹æ€§

1. **é˜²é‡å…¥æ”»å‡»**
```solidity
function deposit(uint256 amount) external nonReentrant {
    // ...
}
```

2. **è§’è‰²æƒé™æ§åˆ¶**
```solidity
function adminWithdraw(address user, uint256 amount) 
    external 
    onlyRole(MANAGER) 
{
    // ...
}
```

3. **è¾“å…¥éªŒè¯**
```solidity
if (amount == 0) revert ErrorsLib.ZeroAmount();
if (admin == address(0)) revert ErrorsLib.ZeroAddress();
```

4. **SafeERC20**
```solidity
using SafeERC20 for IERC20;
_underlyingToken().safeTransfer(msg.sender, amount);
```

---

## æµç¨‹å›¾

### ç”¨æˆ·äº¤äº’æµç¨‹

```mermaid
graph TB
    A[ç”¨æˆ·å¼€å§‹] --> B{é€‰æ‹©æ“ä½œ}
    B -->|å­˜æ¬¾| C[è°ƒç”¨ deposit]
    B -->|å­˜æ¬¾+Permit| D[è°ƒç”¨ depositWithPermit]
    
    C --> E[è½¬å…¥ USDC]
    D --> E
    E --> F[æ›´æ–° userAssets.totalAmount]
    F --> G[æ›´æ–° tvl]
    G --> H[å‘å‡º Deposit äº‹ä»¶]
    H --> I[å­˜æ¬¾å®Œæˆ]
    
    I --> J{ç®¡ç†å‘˜æ“ä½œ}
    J -->|æå–èµ„é‡‘| K[adminWithdraw]
    K --> L[é”å®šç”¨æˆ·èµ„äº§]
    L --> M[è½¬è´¦åˆ°ç®¡ç†å‘˜]
    M --> N[é“¾ä¸‹äº¤æ˜“]
    
    N --> O[äº¤æ˜“å®Œæˆ]
    O --> P[ç®¡ç†å‘˜è°ƒç”¨ updateUserPositionAndAssets]
    P --> Q{äº¤æ˜“ç±»å‹}
    
    Q -->|ä¹°å…¥| R[_processInvestTrade]
    Q -->|å–å‡º| S[_processWithdrawTrade]
    
    R --> T[æ›´æ–°æŒä»“ä»½é¢]
    R --> U[è®¡ç®—åŠ æƒå¹³å‡ä»·]
    R --> V[å‡å°‘ lockedAmount]
    
    S --> W[è®¡ç®—ç›ˆäº]
    W --> X{æ˜¯å¦ç›ˆåˆ©?}
    X -->|æ˜¯| Y[è®¡ç®—æ‰‹ç»­è´¹]
    X -->|å¦| Z[è®°å½•äºæŸ]
    Y --> AA[åˆ†é…å‡€åˆ©æ¶¦]
    Z --> AA
    AA --> AB[æ›´æ–°å¤´å¯¸]
    AB --> AC[å‘å‡º TradeProcessed äº‹ä»¶]
    
    AC --> AD{ç”¨æˆ·æƒ³æå–?}
    AD -->|æ˜¯| AE[è°ƒç”¨ unlockInvestmentShares]
    AE --> AF[åˆ›å»ºè§£é”è¯·æ±‚]
    AF --> AG[ç­‰å¾…é”å®šæœŸ]
    AG --> AH[é”å®šæœŸè¿‡å]
    AH --> AI[ç®¡ç†å‘˜å¤„ç†è¯·æ±‚]
    AI --> AJ[å¢åŠ  unlockedAmount]
    AJ --> AK[ç”¨æˆ·è°ƒç”¨ withdraw]
    AK --> AL[è½¬è´¦ USDC ç»™ç”¨æˆ·]
    AL --> AM[ææ¬¾å®Œæˆ]
```

### åˆçº¦å‡çº§æµç¨‹

```mermaid
graph LR
    A[StrategyVault V1] --> B[éƒ¨ç½² V2 å®ç°åˆçº¦]
    B --> C{Admin è°ƒç”¨ upgradeToAndCall}
    C --> D[éªŒè¯æƒé™]
    D --> E[æ›´æ–° ERC1967 å­˜å‚¨æ§½]
    E --> F[ä»£ç†æŒ‡å‘æ–°å®ç°]
    F --> G[StrategyVault V2]
    G --> H[æ•°æ®ä¿ç•™]
    H --> I[åŠŸèƒ½éªŒè¯]
    I --> J{æµ‹è¯•é€šè¿‡?}
    J -->|æ˜¯| K[å‡çº§å®Œæˆ]
    J -->|å¦| L[å›æ»š]
    L --> A
```

### Factory åˆ›å»º Vault æµç¨‹

```mermaid
graph TB
    A[è°ƒç”¨ createVault] --> B[éªŒè¯å‚æ•°]
    B --> C{ç­–ç•¥ç¬¦å·å·²å­˜åœ¨?}
    C -->|æ˜¯| D[æŠ›å‡ºé”™è¯¯]
    C -->|å¦| E[éƒ¨ç½² ERC1967Proxy]
    E --> F[ç¼–ç åˆå§‹åŒ–æ•°æ®]
    F --> G[è°ƒç”¨ proxy åˆå§‹åŒ–]
    G --> H[åˆå§‹åŒ– StrategyVault]
    H --> I[è®¾ç½®è§’è‰²]
    I --> J[è®°å½• symbolVault]
    J --> K[æ·»åŠ åˆ° allVaults]
    K --> L[å‘å‡º VaultCreated äº‹ä»¶]
    L --> M[è¿”å› Vault åœ°å€]
```

---

## é™„å½•

### A. åˆçº¦åœ°å€ï¼ˆLocalhost æµ‹è¯•ç½‘ï¼‰
```
MockUSDC: 0x5FbDB2315678afecb367f032d93F642f64180aa3
StrategyVault å®ç°: 0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512
StrategyVaultFactory: 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0

ç­–ç•¥å®ä¾‹:
- ETH-PERP-LONG: 0x75537828f2ce51be7289709686A69CbFDbB714F1
- BTC-PERP-LONG: 0xE451980132E65465d0a498c53f0b5227326Dd73F
- SOL-PERP-LONG: 0x5392A33F7F677f59e833FEBF4016cDDD88fF9E67
```

### B. è§’è‰²è¯´æ˜
- **DEFAULT_ADMIN_ROLE**: æœ€é«˜æƒé™ï¼Œå¯å‡çº§åˆçº¦
- **MANAGER**: ç®¡ç†å‘˜ï¼Œå¯è®¾ç½®æ‰‹ç»­è´¹ã€æ³¨å†Œæ ‡çš„ã€å¤„ç†äº¤æ˜“
- **CURATOR**: ç­–å±•äººï¼ˆé¢„ç•™ï¼‰
- **ALLOCATOR**: åˆ†é…è€…ï¼ˆé¢„ç•™ï¼‰
- **BOT**: æœºå™¨äººï¼Œè‡ªåŠ¨åŒ–å¤„ç†ï¼ˆé¢„ç•™ï¼‰

### C. å¸¸é‡é…ç½®
```solidity
FEE_BASE = 10000                    // æ‰‹ç»­è´¹åŸºæ•° (100%)
MAX_FEE_RATE = 5000                 // æœ€å¤§æ‰‹ç»­è´¹ (50%)
MIN_REQUEST_LOCK_TIME = 7 days     // æœ€å°é”å®šæœŸ
MAX_REQUEST_LOCK_TIME = 15 days    // æœ€å¤§é”å®šæœŸ
```

### D. ç›¸å…³æ–‡æ¡£
- [OpenZeppelin å‡çº§æ’ä»¶](https://docs.openzeppelin.com/upgrades-plugins)
- [ERC1967 æ ‡å‡†](https://eips.ethereum.org/EIPS/eip-1967)
- [Hardhat æ–‡æ¡£](https://hardhat.org/docs)
- [Slither æ–‡æ¡£](https://github.com/crytic/slither)

---

## æ€»ç»“

QuanterFi ç­–ç•¥åˆçº¦ç³»ç»Ÿé€šè¿‡ç²¾å¿ƒè®¾è®¡çš„å¯å‡çº§æ¶æ„ã€é«˜æ•ˆçš„ Gas ä¼˜åŒ–å’Œå®Œå–„çš„å®‰å…¨æœºåˆ¶ï¼Œä¸ºç”¨æˆ·æä¾›äº†å¯é çš„å»ä¸­å¿ƒåŒ–æŠ•èµ„ç­–ç•¥ç®¡ç†å¹³å°ã€‚ç³»ç»Ÿå·²é€šè¿‡ 33 é¡¹å…¨é¢æµ‹è¯•ï¼ŒGas ä¼˜åŒ–å¹³å‡èŠ‚çœ 10%ï¼Œå¹¶é€šè¿‡äº† Slither é™æ€åˆ†æã€‚

**å…³é”®æˆå°±**ï¼š
- âœ… 100% æµ‹è¯•è¦†ç›–
- âœ… å¹³å‡ Gas èŠ‚çœ 10%+
- âœ… UUPS å¯å‡çº§æ”¯æŒ
- âœ… å·¥å‚æ¨¡å¼æ‰¹é‡éƒ¨ç½²
- âœ… å®‰å…¨å®¡è®¡é€šè¿‡

---

*æ–‡æ¡£ç‰ˆæœ¬*: v1.0.0  
*æœ€åæ›´æ–°*: 2024-11-14  
*ä½œè€…*: QuanterFi å›¢é˜Ÿ
